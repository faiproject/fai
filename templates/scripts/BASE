#! /usr/bin/cfengine

##############################################################
#
# cf.base - for informatik.uni-koeln.de
#
#################################################################

control:


   OutputPrefix = ("${cf_prefix}")

   actionsequence = ( 
		      tidy
                      files
		      copy
		      editfiles
		      shellcommands
		    )

tidy:

   !TMP_PARTITION::
	${target}/tmp  pat=*   age=0 rmdirs=true
	${target}/     pat=tmp age=0 rmdirs=true

copy:
   any::
	${files}/root/.bash_profile	dest=${target}/root/.bash_profile
           m=640 o=root g=root  
	   force=${force} backup=${backup}
	${files}/root/.bashrc		dest=${target}/root/.bashrc
           m=640 o=root g=root  
	   force=${force} backup=${backup}
	${files}/root/.cshrc	dest=${target}/root/.cshrc
           m=640 o=root g=root  
	   force=${force} backup=${backup}
	${files}/root/.login	dest=${target}/root/.login
           m=640 o=root g=root  
	   force=${force} backup=${backup}
	${files}/root/.alias	dest=${target}/root/.alias
           m=640 o=root g=root  
	   force=${force} backup=${backup}
	${files}/root/.emacs	dest=${target}/root/.emacs
           m=640 o=root g=root  
	   force=${force} backup=${backup}

editfiles:
   any::

	{ ${target}/etc/default/rcS
	  ReplaceAll "^UTC=.*" With "UTC=${UTC}"
	}

	{ ${target}/etc/init.d/sysklogd
	  ReplaceAll "^SYSLOGD=.*" With "SYSLOGD=${dblquote}-m 240${dblquote}"
	}

	{ ${target}/etc/passwd
	  LocateLineMatching 	"^root:.*"
	  InsertLine 		"roott::0:0:root:/root:/usr/bin/tcsh"
	  ReplaceAll 		"^root::" With "root:${rootpw}:"
	  ReplaceAll		"^roott::" With "roott:${rootpw}:"
	}

	{ ${target}/etc/syslog.conf
	  ReplaceAll "daemon.*/var/log/daemon.log"
		With "daemon.warn${tab}${tab}${tab}-/var/log/daemon.log"
	  ReplaceAll "kern.*/var/log/kern.log"
		With "kern.warn${tab}${tab}${tab}-/var/log/kern.log"
	  AppendIfNoSuchLine "local6.debug${tab}${tab}${tab}/var/log/daemon.log"
	}

	{ ${target}/etc/fstab
	  AppendIfNoSuchLine "#${FAI_PACKAGEDIR} /mnt nfs ro,rsize=8192,wsize=8192 0 0"
	}

   HOME_CLIENT::
	{ ${target}/etc/fstab
	  HashCommentLinesContaining "/home"
	  AppendIfNoSuchLine "${hserver}:/home /home nfs rw,nosuid,rsize=8192,wsize=8192 0 0"
	}

   USR_MOUNT::
	{ ${target}/etc/fstab
	  HashCommentLinesContaining "/usr"
	  AppendIfNoSuchLine "${bserver}:/usr /usr nfs ro,rsize=8192,wsize=8192 0 0"
	}

   USR_LOCAL_MOUNT::
	{ ${target}/etc/fstab
	  HashCommentLinesContaining "/usr/local"
	  AppendIfNoSuchLine "${bserver}:/usr/local /usr/local nfs ro,rsize=8192,wsize=8192 0 0"
	}

   SCRATCH::
	{ ${target}/etc/exports
	  AutoCreate
	  AppendIfNoSuchLine "/scratch${tab}${tab}@sundomain(rw) @faiclients(rw,no_root_squash)"
	}

   FILES_SCRATCH::
	{ ${target}/etc/exports
	  AutoCreate
	  AppendIfNoSuchLine "/files/scratch${tab}${tab}@sundomain(rw) @faiclients(rw,no_root_squash)"
	}


   FAISERVER::
	{ ${target}/etc/exports
	  AppendIfNoSuchLine "/usr${tab}${tab}@faiclients(ro,no_root_squash)"
	}

shellcommands:
   # create this tar-file on your debian-binserver with:
   # tar -cf FAICLIENT -C /etc/alternatives .
   FAICLIENT.DATALESS::
	"/bin/tar -C ${target}/etc/alternatives -xvpf ${files}/etc/alternatives/FAICLIENT"
